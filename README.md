# BpmEstimator
音楽ファイルを読み込んでBPMを推定するWindowsコンソールアプリケーションです。  
WAV, MP3に対応しています。

## 動作確認環境
- Windows11
- Windows10

## 使い方
起動すると`Input: `と表示されるので、BPMを推定したいファイルのパスを入力してください。  
コマンドライン引数で対象のファイルを直接指定することもできます。  
推定が終了すると以下のように表示されます。
```
Channel 1:
  Bpm = 69.00, Amplitude = 3624, Phase = 0.422sec
  Bpm = 138.00, Amplitude = 2328, Phase = -0.018sec
  Bpm = 207.00, Amplitude = 1368, Phase = 0.084sec
Channel 2:
  Bpm = 69.00, Amplitude = 3623, Phase = 0.422sec
  Bpm = 138.00, Amplitude = 2328, Phase = -0.018sec
  Bpm = 207.00, Amplitude = 1367, Phase = 0.084sec
```
推定は各チャンネルごとに行われ、BPM候補が可能性の高い順に3つ表示されます。
- `Bpm`は推定されたBPMを表します。
- `Amplitude`は推定されたBPMとのマッチ度を表します。
  - この値が高い順に表示されますが、数値が近い場合は優劣はないと考えたほうがよさそうです。
- `Phase`は先頭の拍までの時間を示します。（負の数が表示されることもあります）

## オプション
`MinBPM`, `MaxBPM`, `Step`の3つを指定できます。推定は`MinBPM`から始まり、`Step`ずつ値を増やしながら`MaxBPM`に至るまで行われます。  
以下をコマンドライン引数として指定してください。（`***`には正の数値が入ります）
- `-min=***`
  - `MinBPM`を指定します。デフォルトは`60`です。
- `-max=***`
  - `MaxBPM`を指定します。デフォルトは`240`です。
- `-step=***`
  - `Step`を指定します。デフォルトは`1`です。

なおコマンドライン引数を与えずに起動した場合でも、対象となるファイルを入力する際に上記オプションを半角スペースで区切りながら入力すれば機能します。

## 注意事項
- チャンネル数が2ではないファイルはサポートしていません。
- 1サンプルあたりのビット数が16ではないファイルはサポートしていません。
- BPMの変動が激しい曲の場合は正しい数値が出ません。

## 使用技術と選定理由
- C# 10
- .NET 6

処理速度向上のため、PLINQによって並列化がかなり楽に書けるC#を採用しています。

## 動作原理
音楽は拍の立ち上がりで音量が大きく増加することが多いため、極小時間における音量の増分をフーリエ変換することで周波数解析を行います。
1. 波形データを極小時間のフレームに分割します。
1. フレームごとの平均音量を求めます。
1. 前のフレームとの音量の増分を求めます。この際、立ち上がりのみを検知するために増分が負になる場合は0とみなします。
1. フーリエ変換を行い、振幅スペクトルと位相を得ます。
1. 振幅スペクトルが高い順に3つを表示します。

## このアプリケーションを作った契機
個人利用で楽しむための音楽ゲームの譜面を作る際に、手動のBPM測定器では1BPM未満の精度での測定が難しいため、自動判定を試みたいと思い作成しました。  

## 参考にしたページ
[C/C++言語で音声ファイルのテンポ解析を行うサンプルプログラム](http://hp.vector.co.jp/authors/VA046927/tempo/tempo.html)
